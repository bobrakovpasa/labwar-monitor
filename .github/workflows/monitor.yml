name: LabWar Monitor

on:
  schedule:
    # –ö–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç
    - cron: '*/10 * * * *'
  workflow_dispatch:  # –î–ª—è —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞

jobs:
  monitor:
    runs-on: ubuntu-latest
    
    steps:
    - name: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è
      run: |
        apt-get update
        apt-get install -y curl
        echo "‚úÖ –û–∫—Ä—É–∂–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ"
    
    - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–≥—Ä–æ–∫–æ–≤
      run: |
        echo "=== –ó–ê–ü–£–°–ö –ú–û–ù–ò–¢–û–†–ê ==="
        echo "–í—Ä–µ–º—è: $(date '+%H:%M:%S')"
        
        # –¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram
        curl -s -X POST "https://api.telegram.org/bot${{ secrets.BOT_TOKEN }}/sendMessage" \
          -d chat_id="${{ secrets.CHAT_ID }}" \
          -d text="üîÑ –ú–æ–Ω–∏—Ç–æ—Ä –∑–∞–ø—É—â–µ–Ω. –ü—Ä–æ–≤–µ—Ä—è—é –∏–≥—Ä–æ–∫–æ–≤..." \
          -d disable_notification="true"
        
        # –ú–∞—Å—Å–∏–≤ –∏–≥—Ä–æ–∫–æ–≤ (5 –¥–ª—è —Ç–µ—Å—Ç–∞)
        players=("Barmaleikin" "Subbota96" "angel_of_dead1" "Lord555" "Znatok")
        
        # –ß–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫ –º–æ–±–æ–≤
        bad_mobs=("–ú–æ—Ä—Ñ" "–°–µ–∫—Ç–∞–Ω—Ç" "–í–∞–º–ø–∏—Ä-–ø–ª–∞—Å—Ç—É–Ω" "–¢–æ–ø—Ç—É–Ω")
        
        echo "–ò–≥—Ä–æ–∫–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏: ${#players[@]}"
        echo "–ú–æ–±–æ–≤ –≤ —Ñ–∏–ª—å—Ç—Ä–µ: ${#bad_mobs[@]}"
        
        # –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Å–±–æ—Ä–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        battles_found=""
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥–æ–≥–æ –∏–≥—Ä–æ–∫–∞
        for player in "${players[@]}"; do
          echo "---"
          echo "–ü—Ä–æ–≤–µ—Ä—è—é: $player"
          
          # –î–µ–ª–∞–µ–º –∑–∞–ø—Ä–æ—Å —Å —Ç–∞–π–º–∞—É—Ç–æ–º
          response=$(curl -s --max-time 15 "http://labwar.ru/log_infa.php?mod=who&blogin=$player" 2>/dev/null || echo "ERROR_TIMEOUT")
          
          if [ "$response" = "ERROR_TIMEOUT" ]; then
            echo "‚ö†Ô∏è –¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞"
            continue
          fi
          
          if echo "$response" | grep -q "–í –±–æ—é" && echo "$response" | grep -q "–°–º. –±–æ–π"; then
            echo "‚öîÔ∏è –ù–ê–ô–î–ï–ù –ë–û–ô!"
            
            # –ü—ã—Ç–∞–µ–º—Å—è –≤—ã—Ç–∞—â–∏—Ç—å –ª–æ–≥ –±–æ—è
            battle_log=$(echo "$response" | grep -o "–ù–∞ .*–Ω–∞–ø–∞–¥–∞–µ—Ç.*\. –ë–æ–π –Ω–∞—á–∞–ª—Å—è" | head -1)
            
            if [ -n "$battle_log" ]; then
              echo "–õ–æ–≥: $battle_log"
              
              # –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–º—è –º–æ–±–∞
              mob_name=$(echo "$battle_log" | sed 's/.*–Ω–∞–ø–∞–¥–∞–µ—Ç //; s/\. –ë–æ–π –Ω–∞—á–∞–ª—Å—è//; s/\[.*//' | xargs)
              
              if [ -n "$mob_name" ]; then
                echo "–ú–æ–±: $mob_name"
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫
                skip_mob="no"
                for bad_mob in "${bad_mobs[@]}"; do
                  if echo "$mob_name" | grep -iq "$bad_mob"; then
                    echo "üö´ –ü—Ä–æ–ø—É—Å–∫–∞–µ–º (–≤ —á–µ—Ä–Ω–æ–º —Å–ø–∏—Å–∫–µ): $bad_mob"
                    skip_mob="yes"
                    break
                  fi
                done
                
                if [ "$skip_mob" = "no" ]; then
                  # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                  message="‚öîÔ∏è –ë–û–ô: $player
        üïí $(date '+%H:%M:%S')
        üëπ $mob_name
        üìù $battle_log"
                  
                  # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Telegram
                  curl -s -X POST "https://api.telegram.org/bot${{ secrets.BOT_TOKEN }}/sendMessage" \
                    -d chat_id="${{ secrets.CHAT_ID }}" \
                    -d text="$message"
                  
                  echo "‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ"
                  battles_found="$battles_found‚Ä¢ $player vs $mob_name\n"
                fi
              fi
            fi
          else
            echo "–ù–µ –≤ –±–æ—é"
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ê–ë–ö (–∫–∞–∂–¥—ã–π —á–∞—Å –≤ 0 –º–∏–Ω—É—Ç)
            current_minute=$(date +%M)
            if [ "$current_minute" = "00" ]; then
              if echo "$response" | grep -q "–ê—Ä–º–µ–π—Å–∫–∏–π –±–æ–µ–≤–æ–π –∫–æ–∫—Ç–µ–π–ª—å"; then
                echo "üíä –û–±–Ω–∞—Ä—É–∂–µ–Ω –ê–ë–ö"
                curl -s -X POST "https://api.telegram.org/bot${{ secrets.BOT_TOKEN }}/sendMessage" \
                  -d chat_id="${{ secrets.CHAT_ID }}" \
                  -d text="$player –ê–ë–ö" \
                  -d disable_notification="true"
              fi
            fi
          fi
          
          # –ü–∞—É–∑–∞ 2 —Å–µ–∫—É–Ω–¥—ã –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
          sleep 2
        done
        
        echo "=== –ü–†–û–í–ï–†–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê ==="
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç
        if [ -n "$battles_found" ]; then
          report="üìä –û–¢–ß–ï–¢:
        –ù–∞–π–¥–µ–Ω–æ –±–æ—ë–≤: $(echo -e "$battles_found" | grep -c '‚Ä¢')
        $battles_found
        –í—Ä–µ–º—è: $(date '+%H:%M:%S')"
        else
          report="üìä –û–¢–ß–ï–¢: –ê–∫—Ç–∏–≤–Ω—ã—Ö –±–æ—ë–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –í—Ä–µ–º—è: $(date '+%H:%M:%S')"
        fi
        
        curl -s -X POST "https://api.telegram.org/bot${{ secrets.BOT_TOKEN }}/sendMessage" \
          -d chat_id="${{ secrets.CHAT_ID }}" \
          -d text="$report" \
          -d disable_notification="true"
        
        echo "‚úÖ –û—Ç—á–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω"
