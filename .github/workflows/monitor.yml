name: LabWar Monitor

on:
  schedule:
    - cron: '*/10 * * * *'  # –ö–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    
    steps:
    - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–≥—Ä–æ–∫–æ–≤
      run: |
        echo "=== –ó–ê–ü–£–°–ö –ú–û–ù–ò–¢–û–†–ê ==="
        echo "–í—Ä–µ–º—è: $(date '+%H:%M:%S')"
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å—Ç–∞—Ä—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        curl -s -X POST "https://api.telegram.org/bot${{ secrets.BOT_TOKEN }}/sendMessage" \
          -d chat_id="${{ secrets.CHAT_ID }}" \
          -d text="üîÑ –ú–æ–Ω–∏—Ç–æ—Ä –∑–∞–ø—É—â–µ–Ω. –í—Ä–µ–º—è: $(date '+%H:%M:%S')"
        
        # 1. –°–Ω–∞—á–∞–ª–∞ –∞–≤—Ç–æ—Ä–∏–∑—É–µ–º—Å—è –∏ –ø–æ–ª—É—á–∞–µ–º –∫—É–∫–∏
        echo "üîê –ê–≤—Ç–æ—Ä–∏–∑—É—é—Å—å –≤ –∏–≥—Ä–µ..."
        
        # –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª –¥–ª—è –∫—É–∫–æ–≤
        COOKIE_FILE="labwar_cookies.txt"
        
        # –î–µ–ª–∞–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
        curl -s -c "$COOKIE_FILE" "http://labwar.ru/index.php?mod=autorize&login=bot1&pass=00000000&scin=" > /dev/null
        
        if [ ! -f "$COOKIE_FILE" ]; then
          echo "‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏"
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.CHAT_ID }}" \
            -d text="‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤ –∏–≥—Ä–µ"
          exit 1
        fi
        
        echo "‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞"
        
        # 2. –¢–µ–ø–µ—Ä—å –ø—Ä–æ–≤–µ—Ä—è–µ–º –∏–≥—Ä–æ–∫–æ–≤ —Å –∫—É–∫–∞–º–∏
        players=("Barmaleikin" "Subbota96" "angel_of_dead1")
        
        for player in "${players[@]}"; do
          echo "---"
          echo "–ò–≥—Ä–æ–∫: $player"
          
          # –î–µ–ª–∞–µ–º –∑–∞–ø—Ä–æ—Å —Å –∫—É–∫–∞–º–∏
          response=$(curl -s -b "$COOKIE_FILE" --max-time 10 \
            "http://labwar.ru/log_infa.php?mod=who&blogin=$player" 2>/dev/null || echo "ERROR")
          
          if [ "$response" = "ERROR" ]; then
            echo "–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞"
          elif echo "$response" | grep -q "–í –±–æ—é" && echo "$response" | grep -q "–°–º. –±–æ–π"; then
            echo "‚öîÔ∏è –í –ë–û–Æ!"
            
            # –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –ª–æ–≥ –±–æ—è
            battle_log=$(echo "$response" | grep -o "–ù–∞ .*–Ω–∞–ø–∞–¥–∞–µ—Ç.*\. –ë–æ–π –Ω–∞—á–∞–ª—Å—è" | head -1)
            
            if [ -n "$battle_log" ]; then
              echo "–õ–æ–≥: $battle_log"
              
              # –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–º—è –º–æ–±–∞
              mob_name=$(echo "$battle_log" | sed 's/.*–Ω–∞–ø–∞–¥–∞–µ—Ç //; s/\. –ë–æ–π –Ω–∞—á–∞–ª—Å—è//; s/\[.*//' | xargs)
              
              if [ -n "$mob_name" ]; then
                echo "–ú–æ–±: $mob_name"
                
                # –ü—Ä–æ—Å—Ç–æ–π —á–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫
                if [[ ! "$mob_name" =~ [–ú–º]–æ—Ä—Ñ ]] && \
                   [[ ! "$mob_name" =~ [–°—Å]–µ–∫—Ç–∞–Ω—Ç ]] && \
                   [[ ! "$mob_name" =~ [–¢—Ç]–æ–ø—Ç—É–Ω ]]; then
                  
                  echo "‚úÖ –ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π –º–æ–±!"
                  
                  # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                  curl -s -X POST "https://api.telegram.org/bot${{ secrets.BOT_TOKEN }}/sendMessage" \
                    -d chat_id="${{ secrets.CHAT_ID }}" \
                    -d text="‚öîÔ∏è –ë–û–ô: $player
        üïí $(date '+%H:%M:%S')
        üëπ $mob_name"
                else
                  echo "üö´ –ú–æ–± –≤ —á–µ—Ä–Ω–æ–º —Å–ø–∏—Å–∫–µ"
                fi
              fi
            fi
          else
            echo "–ù–µ –≤ –±–æ—é"
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ê–ë–ö
            if echo "$response" | grep -q "–ê—Ä–º–µ–π—Å–∫–∏–π –±–æ–µ–≤–æ–π –∫–æ–∫—Ç–µ–π–ª—å"; then
              echo "üíä –û–±–Ω–∞—Ä—É–∂–µ–Ω –ê–ë–ö"
              
              # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–∞–∑ –≤ 2 —á–∞—Å–∞ (–≤ 00 –∏ 30 –º–∏–Ω—É—Ç)
              current_minute=$(date +%M)
              if [ "$current_minute" = "00" ] || [ "$current_minute" = "30" ]; then
                curl -s -X POST "https://api.telegram.org/bot${{ secrets.BOT_TOKEN }}/sendMessage" \
                  -d chat_id="${{ secrets.CHAT_ID }}" \
                  -d text="$player –ê–ë–ö" \
                  -d disable_notification="true"
              fi
            fi
          fi
          
          sleep 2
        done
        
        # –£–¥–∞–ª—è–µ–º —Ñ–∞–π–ª —Å –∫—É–∫–∞–º–∏
        rm -f "$COOKIE_FILE"
        
        echo "=== –ó–ê–í–ï–†–®–ï–ù–û ==="
        
        # –§–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        curl -s -X POST "https://api.telegram.org/bot${{ secrets.BOT_TOKEN }}/sendMessage" \
          -d chat_id="${{ secrets.CHAT_ID }}" \
          -d text="‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –í—Ä–µ–º—è: $(date '+%H:%M:%S')" \
          -d disable_notification="true"
