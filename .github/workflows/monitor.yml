name: LabWar Monitor

on:
  schedule:
    # –ö–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç (–º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å)
    - cron: '*/5 * * * *'
  workflow_dispatch:  # –î–ª—è —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞

jobs:
  check-players:
    runs-on: ubuntu-latest
    
    steps:
    - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –ø—Ä–æ–≥—Ä–∞–º–º
      run: |
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å–∏—Å—Ç–µ–º—É
        sudo apt-get update
        echo "‚úÖ –°–∏—Å—Ç–µ–º–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞"
    
    - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤
      run: |
        echo "üöÄ –ó–∞–ø—É—Å–∫–∞—é –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥..."
        echo "–í—Ä–µ–º—è: $(date '+%H:%M:%S %d.%m.%Y')"
        
        # –°–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤ (–í–°–ï –≤–∞—à–∏ –∏–≥—Ä–æ–∫–∏)
        PLAYERS=(
          "Barmaleikin" "Subbota96" "angel_of_dead1"
          "syslenok_88" "Lord555" "Znatok" "Sprei"
          "OBRON555" "den77" "CaIIIeHbkA" "_4ka_" "MeinKrieg"
          "_ASUS_" "AvtoRitet" "Zipp0_" "_DONZ_" "B_A_T"
          "xxxMAXxxx" "Klassik" "CHIPS" "Diabolo" "Ded1"
          "RED_HEAD_" "ShymaXER" "Krot13" "KAMAZ"
          "1Kazak1" "4uKaTuJIo" "PeaceDeath" "xXx_stalker_xXx" "jafar"
          "aleksandr_25" "Eclerhik" "Sharliz" "Wolf9" "PaHDoM"
        )
        
        echo "üë• –í—Å–µ–≥–æ –∏–≥—Ä–æ–∫–æ–≤: ${#PLAYERS[@]}"
        
        # –ß–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫ –º–æ–±–æ–≤ (–ø–µ—Ä–≤—ã–µ 10 –¥–ª—è —Ç–µ—Å—Ç–∞)
        BAD_MOBS=(
          "–ú–æ—Ä—Ñ" "–°–µ–∫—Ç–∞–Ω—Ç" "–í–∞–º–ø–∏—Ä-–ø–ª–∞—Å—Ç—É–Ω" "–°–µ—Ä–µ–±—Ä–∏—Å—Ç—ã–π –ú–æ—Ä—Ñ"
          "–¢–æ–ø—Ç—É–Ω" "–¢—Ä—É–ø–æ–µ–¥" "–ì–∏–≥–∞–Ω—Ç—Å–∫–∏–π –ú–æ—Ä—Ñ" "–ë–æ–µ—Ü"
          "–û—Ö—Ä–∞–Ω–Ω–∏–∫" "–°—Ç–∞—Ä—ã–π —Ä–æ–±–æ—Ç"
        )
        
        echo "üö´ –ú–æ–±–æ–≤ –≤ —Ñ–∏–ª—å—Ç—Ä–µ: ${#BAD_MOBS[@]}"
        
        # –§–∞–π–ª –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤ (—á—Ç–æ–±—ã –Ω–µ —Å–ø–∞–º–∏—Ç—å)
        STATUS_FILE="player_status.txt"
        
        # –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
        if [ ! -f "$STATUS_FILE" ]; then
          echo "–°–æ–∑–¥–∞—é —Ñ–∞–π–ª —Å—Ç–∞—Ç—É—Å–æ–≤..."
          for P in "${PLAYERS[@]}"; do
            echo "$P:unknown" >> "$STATUS_FILE"
          done
        fi
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥–æ–≥–æ –∏–≥—Ä–æ–∫–∞
        for PLAYER in "${PLAYERS[@]}"
        do
          echo "---"
          echo "üîç –ü—Ä–æ–≤–µ—Ä—è—é: $PLAYER"
          
          # –ü–æ–ª—É—á–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–≥—Ä–æ–∫–∞
          URL="http://labwar.ru/log_infa.php?mod=who&blogin=$PLAYER"
          echo "üì° –ó–∞–ø—Ä–æ—Å: $URL"
          
          # –î–µ–ª–∞–µ–º –∑–∞–ø—Ä–æ—Å —Å —Ç–∞–π–º–∞—É—Ç–æ–º
          RESPONSE=$(curl -s --max-time 10 "$URL" || echo "ERROR")
          
          if [ "$RESPONSE" = "ERROR" ]; then
            echo "‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –¥–ª—è $PLAYER"
            continue
          fi
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –±–æ—è
          OLD_STATUS=$(grep "^$PLAYER:" "$STATUS_FILE" | cut -d: -f2)
          
          if echo "$RESPONSE" | grep -q "–í –±–æ—é" && echo "$RESPONSE" | grep -q "–°–º. –±–æ–π"; then
            NEW_STATUS="in_battle"
            echo "‚öîÔ∏è $PLAYER –≤ –±–æ—é!"
            
            # –ï—Å–ª–∏ –±—ã–ª –Ω–µ –≤ –±–æ—é, –∞ —Ç–µ–ø–µ—Ä—å –≤ –±–æ—é - –ø—Ä–æ–≤–µ—Ä—è–µ–º –¥–µ—Ç–∞–ª–∏
            if [ "$OLD_STATUS" != "in_battle" ]; then
              echo "üéØ –ù–æ–≤—ã–π –±–æ–π! –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º..."
              
              # –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –ª–æ–≥ –±–æ—è
              BATTLE_LOG=$(echo "$RESPONSE" | grep -o "–ù–∞ .*–Ω–∞–ø–∞–¥–∞–µ—Ç.*\. –ë–æ–π –Ω–∞—á–∞–ª—Å—è" | head -1)
              
              if [ -n "$BATTLE_LOG" ]; then
                echo "üìù –õ–æ–≥ –±–æ—è: $BATTLE_LOG"
                
                # –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–º—è –º–æ–±–∞
                MOB_NAME=$(echo "$BATTLE_LOG" | sed 's/.*–Ω–∞–ø–∞–¥–∞–µ—Ç //; s/\. –ë–æ–π –Ω–∞—á–∞–ª—Å—è//; s/\[.*//' | xargs)
                
                if [ -n "$MOB_NAME" ]; then
                  echo "üëπ –ú–æ–±: $MOB_NAME"
                  
                  # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫
                  MOB_FOUND="no"
                  for BAD_MOB in "${BAD_MOBS[@]}"; do
                    if echo "$MOB_NAME" | grep -iq "$BAD_MOB"; then
                      MOB_FOUND="yes"
                      break
                    fi
                  done
                  
                  if [ "$MOB_FOUND" = "no" ]; then
                    echo "‚úÖ –ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π –º–æ–±! –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ"
                    
                    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Telegram
                    MESSAGE="‚öîÔ∏è –ë–û–ô: $PLAYER
üïí $(date '+%H:%M:%S')
üìù $BATTLE_LOG"
                    
                    curl -s -X POST "https://api.telegram.org/bot${{ secrets.BOT_TOKEN }}/sendMessage" \
                      -d chat_id="${{ secrets.CHAT_ID }}" \
                      -d text="$MESSAGE"
                    
                    echo "üì§ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ"
                  else
                    echo "üö´ –ú–æ–± –≤ —á–µ—Ä–Ω–æ–º —Å–ø–∏—Å–∫–µ, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º"
                  fi
                else
                  echo "‚ùì –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–æ–±–∞"
                  
                  # –í—Å–µ —Ä–∞–≤–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º, –Ω–æ —Å –ø–æ–º–µ—Ç–∫–æ–π
                  MESSAGE="‚öîÔ∏è –ë–û–ô: $PLAYER
üïí $(date '+%H:%M:%S')
‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –≤—Ä–∞–≥
üìù $BATTLE_LOG"
                  
                  curl -s -X POST "https://api.telegram.org/bot${{ secrets.BOT_TOKEN }}/sendMessage" \
                    -d chat_id="${{ secrets.CHAT_ID }}" \
                    -d text="$MESSAGE"
                fi
              else
                echo "‚ö†Ô∏è –õ–æ–≥ –±–æ—è –Ω–µ –Ω–∞–π–¥–µ–Ω"
              fi
            else
              echo "‚ÜîÔ∏è –ë–æ–π –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è (—É–∂–µ —Å–æ–æ–±—â–∞–ª–∏)"
            fi
            
          else
            NEW_STATUS="not_in_battle"
            echo "üò¥ $PLAYER –Ω–µ –≤ –±–æ—é"
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ê–ë–ö (—Ä–∞–∑ –≤ 2 —á–∞—Å–∞ –≤ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–µ –º–∏–Ω—É—Ç—ã)
            CURRENT_MINUTE=$(date +%M)
            if echo "$RESPONSE" | grep -q "–ê—Ä–º–µ–π—Å–∫–∏–π –±–æ–µ–≤–æ–π –∫–æ–∫—Ç–µ–π–ª—å"; then
              if [ "$CURRENT_MINUTE" = "00" ] || [ "$CURRENT_MINUTE" = "30" ]; then
                echo "üíä $PLAYER —Å –ê–ë–ö! –û—Ç–ø—Ä–∞–≤–ª—è–µ–º..."
                
                curl -s -X POST "https://api.telegram.org/bot${{ secrets.BOT_TOKEN }}/sendMessage" \
                  -d chat_id="${{ secrets.CHAT_ID }}" \
                  -d text="$PLAYER –ê–ë–ö"
              fi
            fi
          fi
          
          # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ —Ñ–∞–π–ª–µ
          sed -i "s/^$PLAYER:.*/$PLAYER:$NEW_STATUS/" "$STATUS_FILE"
          
          # –ü–∞—É–∑–∞ –º–µ–∂–¥—É –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏ –∏–≥—Ä–æ–∫–æ–≤
          sleep 1
        done
        
        echo "---"
        echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
        echo "–í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è: $(date '+%H:%M:%S')"
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç
        curl -s -X POST "https://api.telegram.org/bot${{ secrets.BOT_TOKEN }}/sendMessage" \
          -d chat_id="${{ secrets.CHAT_ID }}" \
          -d text="üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –ò–≥—Ä–æ–∫–æ–≤: ${#PLAYERS[@]}. –í—Ä–µ–º—è: $(date '+%H:%M:%S')" \
          -d disable_notification="true"
    
    - name: –û—á–∏—Å—Ç–∫–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
      run: |
        echo "üßπ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
