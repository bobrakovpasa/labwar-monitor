name: LabWar Player Monitor
on:
  # –ó–∞–ø—É—Å–∫ –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
  schedule:
    - cron: '*/5 * * * *'
  # –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∑–∞–ø—É—Å–∫–∞ –≤—Ä—É—á–Ω—É—é
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Run monitoring script
      env:
        # –°–µ–∫—Ä–µ—Ç—ã –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è GitHub
        BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
        CHAT_ID: ${{ secrets.CHAT_ID }}
      run: |
        # –°–æ–∑–¥–∞–µ–º —Ä–∞–±–æ—á–∏–µ —Ñ–∞–π–ª—ã
        mkdir -p tmp
        COOKIE_FILE="tmp/cookies.txt"
        PLAYERS_FILE="tmp/players.txt"
        ABK_TIMESTAMP_FILE="tmp/abk_timestamps.txt"
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–∞–π–ª–∞ –º–µ—Ç–æ–∫ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –ê–ë–ö (–µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
        if [ ! -f "$ABK_TIMESTAMP_FILE" ]; then
          echo "{}" > "$ABK_TIMESTAMP_FILE"
        fi
        
        # –°–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
        cat > "$PLAYERS_FILE" << 'EOF'
        Barmaleikin
        Subbota96
        angel_of_dead1
        syslenok_88
        Lord555
        Znatok
        Sprei
        OBRON555
        den77
        CaIIIeHbkA
        _4ka_
        MeinKrieg
        _ASUS_
        AvtoRitet
        Zipp0_
        _DONZ_
        B_A_T
        xxxMAXxxx
        Klassik
        CHIPS
        Diabolo
        Ded1
        RED_HEAD_
        ShymaXER
        Krot13
        KAMAZ
        1Kazak1
        4uKaTuJIo
        PeaceDeath
        xXx_stalker_xXx
        jafar
        aleksandr_25
        Eclerhik
        Sharliz
        Wolf9
        PaHDoM
        EOF
        
        # –ß–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫ –º–æ–±–æ–≤
        BLACKLIST="–ú–æ—Ä—Ñ,–°–µ–∫—Ç–∞–Ω—Ç,–í–∞–º–ø–∏—Ä-–ø–ª–∞—Å—Ç—É–Ω,–°–µ—Ä–µ–±—Ä–∏—Å—Ç—ã–π –ú–æ—Ä—Ñ,–¢–æ–ø—Ç—É–Ω,–¢—Ä—É–ø–æ–µ–¥,–†–∞–Ω–µ–Ω—ã–π –í–∞–º–ø–∏—Ä-–ø–ª–∞—Å—Ç—É–Ω,–ì–∏–≥–∞–Ω—Ç—Å–∫–∏–π –ú–æ—Ä—Ñ,–ë–æ–µ—Ü,–û—Ö—Ä–∞–Ω–Ω–∏–∫,–°—Ç–∞—Ä—ã–π —Ä–æ–±–æ—Ç,–°–æ–±–∞–∫–∞-–º—É—Ç–∞–Ω—Ç,–®–Ω—ã—Ä—å,–ë–µ–ª–µ—Å–æ–µ —Å—É—â–µ—Å—Ç–≤–æ,–î–æ–∫—Ç–æ—Ä,–†–∞–∑–≤–µ–¥—á–∏–∫,–ó–¥–æ—Ä–æ–≤—è–∫,–ö–∞–Ω–Ω–∏–±–∞–ª,–†–æ—Å–ª—ã–π –æ—Ö—Ä–∞–Ω–Ω–∏–∫,–ë—É–ª–æ—á–Ω–∏–∫,–ú–∞—Å—Ç–∏—Ñ,–ö—Ä—É–ø–Ω—ã–π —Ä–µ–≤—É–Ω,–°—Ç–∞—Ä—à–∏–π —Ä–∞–∑–≤–µ–¥—á–∏–∫–æ–≤,–ö—É–º—É—Å,–°–Ω–∞–π–ø–µ—Ä,–ë–æ–ª—å—à–æ–π —É—Ä–ª–æ–∫,–ú–∞–ª—ã–π —É—Ä–ª–æ–∫,–†—ç–∫–µ—Ç–∏—Ä,–¢–æ—Ä–≥–æ–≤–µ—Ü,–°—Ç–∞—Ä—à–∏–π —Å–º–µ–Ω—ã,–°–µ—Ä—ã–π —Ä–µ–≤—É–Ω,–°–µ–∫—Ç–∞–Ω—Ç —Å –∫–∏–Ω–∂–∞–ª–æ–º,–†–∞–Ω–µ–Ω—ã–π –ö–∞–Ω–Ω–∏–±–∞–ª,–ö—Ä–∞–ø–∏–≤–Ω–∏–∫,–ë–∞–Ω–¥–∏—Ç,–ù–∏—Ç–æ—á–Ω—ã–π —á–µ—Ä–≤—å,–°–ø–µ—Ü–Ω–∞–∑–æ–≤–µ—Ü,–ú—É—Ä—Ä,–ú–∞–ª—ã–π —Ä–µ–≤—É–Ω,–ó–∞–∫–ª—é—á–µ–Ω–Ω—ã–π,–ß–∞—Å–æ–≤–æ–π –≤ –±–µ—Ä–µ—Ç–µ,–ß–∞—Å–æ–≤–æ–π –≤ –∫–∞—Å–∫–µ,–†–æ—Å–ª—ã–π –±–∞–Ω–¥–∏—Ç,–ì–ª–∞–≤–∞—Ä—å –±–∞–Ω–¥—ã,–°–ø–µ—Ü–º–µ–Ω,–ü—É–ª–µ–º–µ—Ç—á–∏–∫,–í–æ–¥–∏—Ç–µ–ª—å,–°–µ–∫—Å,–í–í–°33,–®—Ç—É—Ä–º–æ–≤–∏–∫,–®—Ç—É—Ä–º–æ–≤–∏–∫-–≤–µ—Ç–µ—Ä–∞–Ω,–°–≤—è–∑–Ω–æ–π,–°—Ç–∞–ª–∫–µ—Ä –ü–µ—Ç—Ä–æ–≤–∏—á,–¢–∞–Ω—Ü–æ–≤—â–∏—Ü–∞ –ì–∞–µ—á–∫–∞,–ë—Ä–æ–¥—è–≥–∞ –°–∫—Ä—É–¥–∂,–ë—Ä–æ–¥—è–≥–∞ –ú–∏–∫–∫–∏,–ó–∞–∫–ª—é—á–µ–Ω–Ω—ã–π —Å –ø—Ä—É—Ç–æ–º,–î–µ–¥—É—à–∫–∞ –ú–æ—Ä–æ–∑,–î–æ—Ö–ª—ã–π –æ—Ö—Ä–∞–Ω–Ω–∏–∫,–°–∞–Ω—Ç–∞ –ö–ª–∞—É—Å,–ó–∞–∫–ª—é—á–µ–Ω–Ω—ã–π —Å —à–æ–∫–µ—Ä–æ–º,–ö—Ä–µ–ø–∫–∏–π –æ—Ö—Ä–∞–Ω–Ω–∏–∫,–ó–∞–∫–ª—é—á–µ–Ω–Ω—ã–π —Å –∑–∞—Ç–æ—á–∫–æ–π,–ë—É–ª—å—Ç–µ—Ä—å–µ—Ä,–ü—Ä–æ—Ö–æ–∂–∏–π,–°—É—Ç–µ–Ω–µ—Ä,–§–ª–æ—Ä–∏—Å—Ç,–ö—É–∑–Ω–µ—Ü,–í—ã—à–∏–±–∞–ª–∞,–ü–æ–≥–æ–Ω—â–∏–∫,–ì—Ä–∞–≤–µ—Ä,–¢—Ä–∞–∫—Ç–∏—Ä—â–∏–∫,–¢–∞–π–Ω—ã–π –ø–æ–∫–ª–æ–Ω–Ω–∏–∫,–ì—Ä–æ–º–∏–ª–∞,–ë–æ—Ä—è,–ë—Ä–æ–¥—è–≥–∞,–ú–æ–Ω—è,–ê–ª–∫–æ–Ω–∞—Ñ—Ç –ê–ª–µ—à–∞,–ß–∞—Å–æ–≤–æ–π,–ê–º–±–∞–ª,–°—Ç—Ä–µ–ª–æ–∫ —ç–∫–∏–ø–∞–∂–∞"
        
        # –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram
        send_telegram() {
          local message="$1"
          curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
            -d chat_id="$CHAT_ID" \
            -d text="$message" \
            -d parse_mode="HTML" \
            --max-time 10
        }
        
        # –§—É–Ω–∫—Ü–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤ –∏–≥—Ä–µ
        auth_to_labwar() {
          echo "üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ LabWar..."
          
          # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Å—ã–ª–∫—É –∞–≤—Ç–æ–ª–æ–≥–∏–Ω–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫—É–∫–∏
          curl -s -c "$COOKIE_FILE" \
            "http://labwar.ru/index.php?mod=autorize&login=bot1&pass=00000000&scin=" \
            --max-time 30 \
            -o /dev/null
          
          if [ -s "$COOKIE_FILE" ]; then
            echo "‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞"
            return 0
          else
            echo "‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏"
            send_telegram "‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤ LabWar"
            return 1
          fi
        }
        
        # –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–≥—Ä–æ–∫–∞
        check_player() {
          local player="$1"
          echo "üë§ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–≥—Ä–æ–∫–∞: $player"
          
          # –î–µ–ª–∞–µ–º –∑–∞–ø—Ä–æ—Å –∫ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∏–≥—Ä–æ–∫–∞ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–º–∏ –∫—É–∫–∞–º–∏
          local player_page=$(curl -s -b "$COOKIE_FILE" \
            "http://labwar.ru/index.php?mod=players&name=$player" \
            --max-time 20)
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å
          if [ -z "$player_page" ]; then
            echo "  ‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–≥—Ä–æ–∫–∞"
            return 1
          fi
          
          # –ò—â–µ–º —Å—Ç–∞—Ç—É—Å "–í –±–æ—é"
          if echo "$player_page" | grep -q "–í –±–æ—é"; then
            echo "  ‚öîÔ∏è –ò–≥—Ä–æ–∫ –≤ –±–æ—é!"
            
            # –ò–∑–≤–ª–µ–∫–∞–µ–º –ª–æ–≥ –±–æ—è (–ø—Ä–∏–º–µ—Ä–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω, –º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞)
            local battle_log=$(echo "$player_page" | grep -A 2 -B 2 "–í –±–æ—é" | head -10 | tr '\n' ' ' | sed 's/  */ /g')
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –º–æ–± –≤ —á–µ—Ä–Ω–æ–º —Å–ø–∏—Å–∫–µ
            local send_notification=true
            for mob in $(echo "$BLACKLIST" | tr ',' ' '); do
              if echo "$battle_log" | grep -qi "$mob"; then
                echo "  üö´ –ú–æ–± '$mob' –≤ —á–µ—Ä–Ω–æ–º —Å–ø–∏—Å–∫–µ, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º"
                send_notification=false
                break
              fi
            done
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –µ—Å–ª–∏ –º–æ–± –Ω–µ –≤ —á–µ—Ä–Ω–æ–º —Å–ø–∏—Å–∫–µ
            if [ "$send_notification" = true ]; then
              local current_time=$(date '+%H:%M:%S')
              local message="‚öîÔ∏è –ë–û–ô: $player üïí $current_time üìù ${battle_log:0:200}..."
              send_telegram "$message"
              echo "  ‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ"
            fi
          else
            echo "  ‚úÖ –ò–≥—Ä–æ–∫ –Ω–µ –≤ –±–æ—é"
          fi
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –ê–ë–ö —É –∏–≥—Ä–æ–∫–∞
          if echo "$player_page" | grep -qi "–ê–ë–ö\|–ê—Ä–º–µ–π—Å–∫–∏–π –±–æ–µ–≤–æ–π –∫–æ–∫—Ç–µ–π–ª—å"; then
            echo "  üç∫ –ù–∞–π–¥–µ–Ω –ê–ë–ö"
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∫–æ–≥–¥–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –ê–ë–ö
            local current_timestamp=$(date +%s)
            local last_notification=$(jq -r --arg player "$player" '.[$player] // 0' "$ABK_TIMESTAMP_FILE" 2>/dev/null || echo "0")
            local two_hours=7200  # 2 —á–∞—Å–∞ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
            
            # –ï—Å–ª–∏ –ø—Ä–æ—à–ª–æ –±–æ–ª—å—à–µ 2 —á–∞—Å–æ–≤, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            if [ $((current_timestamp - last_notification)) -gt $two_hours ]; then
              send_telegram "üç∫ $player –ê–ë–ö"
              echo "  ‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –ê–ë–ö –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ"
              
              # –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
              jq --arg player "$player" --argjson ts "$current_timestamp" \
                '.[$player] = $ts' "$ABK_TIMESTAMP_FILE" > "$ABK_TIMESTAMP_FILE.tmp" \
                && mv "$ABK_TIMESTAMP_FILE.tmp" "$ABK_TIMESTAMP_FILE"
            else
              echo "  ‚è≥ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –ê–ë–ö —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–æ—Å—å –Ω–µ–¥–∞–≤–Ω–æ"
            fi
          fi
          
          # –ü–∞—É–∑–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
          sleep 2
        }
        
        # –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞
        echo "üöÄ –ó–∞–ø—É—Å–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ LabWar"
        
        # –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
        if ! auth_to_labwar; then
          exit 1
        fi
        
        # –ß–∏—Ç–∞–µ–º —Å–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤ –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥–æ–≥–æ
        while IFS= read -r player || [ -n "$player" ]; do
          # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
          player=$(echo "$player" | xargs)
          [ -z "$player" ] && continue
          
          check_player "$player"
        done < "$PLAYERS_FILE"
        
        echo "‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–∞–≤–µ—Ä—à–µ–Ω"
