name: LabWar Monitor

on:
  schedule:
    # –ö–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç (–º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å)
    - cron: '*/5 * * * *'
  workflow_dispatch:  # –î–ª—è —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞

jobs:
  check-players:
    runs-on: ubuntu-latest
    
    steps:
    - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ curl
      run: |
        apt-get update
        apt-get install -y curl
        echo "‚úÖ curl —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    
    - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–≥—Ä–æ–∫–æ–≤
      run: |
        echo "üöÄ –ó–∞–ø—É—Å–∫–∞—é –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥..."
        echo "–í—Ä–µ–º—è: $(date '+%H:%M:%S %d.%m.%Y')"
        
        # –°–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤ (–æ—Å–Ω–æ–≤–Ω—ã–µ –¥–ª—è —Ç–µ—Å—Ç–∞)
        PLAYERS=(
          "Barmaleikin" "Subbota96" "angel_of_dead1"
          "syslenok_88" "Lord555" "Znatok" "Sprei"
          "OBRON555" "den77" "CaIIIeHbkA" "_4ka_" "MeinKrieg"
        )
        
        echo "üë• –ò–≥—Ä–æ–∫–æ–≤: ${#PLAYERS[@]}"
        
        # –ß–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫ –º–æ–±–æ–≤ (—Å–æ–∫—Ä–∞—â–µ–Ω–Ω—ã–π)
        BAD_MOBS=(
          "–ú–æ—Ä—Ñ" "–°–µ–∫—Ç–∞–Ω—Ç" "–í–∞–º–ø–∏—Ä-–ø–ª–∞—Å—Ç—É–Ω" "–°–µ—Ä–µ–±—Ä–∏—Å—Ç—ã–π –ú–æ—Ä—Ñ"
          "–¢–æ–ø—Ç—É–Ω" "–¢—Ä—É–ø–æ–µ–¥" "–ì–∏–≥–∞–Ω—Ç—Å–∫–∏–π –ú–æ—Ä—Ñ" "–ë–æ–µ—Ü"
          "–û—Ö—Ä–∞–Ω–Ω–∏–∫" "–°—Ç–∞—Ä—ã–π —Ä–æ–±–æ—Ç" "–°–æ–±–∞–∫–∞-–º—É—Ç–∞–Ω—Ç" "–®–Ω—ã—Ä—å"
        )
        
        echo "üö´ –ú–æ–±–æ–≤ –≤ —Ñ–∏–ª—å—Ç—Ä–µ: ${#BAD_MOBS[@]}"
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å—Ç–∞—Ä—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        curl -s -X POST "https://api.telegram.org/bot${{ secrets.BOT_TOKEN }}/sendMessage" \
          -d chat_id="${{ secrets.CHAT_ID }}" \
          -d text="üîÑ –ù–∞—á–∏–Ω–∞—é –ø—Ä–æ–≤–µ—Ä–∫—É ${#PLAYERS[@]} –∏–≥—Ä–æ–∫–æ–≤. –í—Ä–µ–º—è: $(date '+%H:%M')" \
          -d disable_notification="true"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥–æ–≥–æ –∏–≥—Ä–æ–∫–∞
        for PLAYER in "${PLAYERS[@]}"
        do
          echo "---"
          echo "üîç –ü—Ä–æ–≤–µ—Ä—è—é: $PLAYER"
          
          # –ü–æ–ª—É—á–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–≥—Ä–æ–∫–∞
          URL="http://labwar.ru/log_infa.php?mod=who&blogin=$PLAYER"
          RESPONSE=$(curl -s --max-time 10 "$URL" 2>/dev/null || echo "ERROR")
          
          if [ "$RESPONSE" = "ERROR" ]; then
            echo "‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è"
            continue
          fi
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –±–æ—è
          if echo "$RESPONSE" | grep -q "–í –±–æ—é" && echo "$RESPONSE" | grep -q "–°–º. –±–æ–π"; then
            echo "‚öîÔ∏è –í –±–æ—é!"
            
            # –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –ª–æ–≥ –±–æ—è
            BATTLE_LOG=$(echo "$RESPONSE" | grep -o "–ù–∞ .*–Ω–∞–ø–∞–¥–∞–µ—Ç.*\. –ë–æ–π –Ω–∞—á–∞–ª—Å—è" | head -1)
            
            if [ -n "$BATTLE_LOG" ]; then
              echo "üìù –õ–æ–≥: $BATTLE_LOG"
              
              # –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–º—è –º–æ–±–∞
              MOB_NAME=$(echo "$BATTLE_LOG" | sed 's/.*–Ω–∞–ø–∞–¥–∞–µ—Ç //; s/\. –ë–æ–π –Ω–∞—á–∞–ª—Å—è//; s/\[.*//' | xargs)
              
              if [ -n "$MOB_NAME" ]; then
                echo "üëπ –ú–æ–±: $MOB_NAME"
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫
                MOB_FOUND="no"
                for BAD_MOB in "${BAD_MOBS[@]}"; do
                  if echo "$MOB_NAME" | grep -iq "$BAD_MOB"; then
                    MOB_FOUND="yes"
                    echo "üö´ –í —á–µ—Ä–Ω–æ–º —Å–ø–∏—Å–∫–µ: $BAD_MOB"
                    break
                  fi
                done
                
                if [ "$MOB_FOUND" = "no" ]; then
                  echo "‚úÖ –ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π –º–æ–±! –û—Ç–ø—Ä–∞–≤–ª—è–µ–º..."
                  
                  # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Telegram
                  MESSAGE="‚öîÔ∏è –ë–û–ô: $PLAYER
        üïí $(date '+%H:%M:%S')
        üìù $BATTLE_LOG"
                  
                  curl -s -X POST "https://api.telegram.org/bot${{ secrets.BOT_TOKEN }}/sendMessage" \
                    -d chat_id="${{ secrets.CHAT_ID }}" \
                    -d text="$MESSAGE"
                fi
              fi
            fi
          else
            echo "üò¥ –ù–µ –≤ –±–æ—é"
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ê–ë–ö (–≤ 0 –∏ 30 –º–∏–Ω—É—Ç —á–∞—Å–∞)
            CURRENT_MINUTE=$(date +%M)
            if echo "$RESPONSE" | grep -q "–ê—Ä–º–µ–π—Å–∫–∏–π –±–æ–µ–≤–æ–π –∫–æ–∫—Ç–µ–π–ª—å"; then
              if [ "$CURRENT_MINUTE" = "00" ] || [ "$CURRENT_MINUTE" = "30" ]; then
                echo "üíä –û–±–Ω–∞—Ä—É–∂–µ–Ω –ê–ë–ö!"
                
                curl -s -X POST "https://api.telegram.org/bot${{ secrets.BOT_TOKEN }}/sendMessage" \
                  -d chat_id="${{ secrets.CHAT_ID }}" \
                  -d text="$PLAYER –ê–ë–ö" \
                  -d disable_notification="true"
              fi
            fi
          fi
          
          # –ü–∞—É–∑–∞ –º–µ–∂–¥—É –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏
          sleep 1
        done
        
        echo "---"
        echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
        
        # –ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç
        curl -s -X POST "https://api.telegram.org/bot${{ secrets.BOT_TOKEN }}/sendMessage" \
          -d chat_id="${{ secrets.CHAT_ID }}" \
          -d text="‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ ${#PLAYERS[@]} –∏–≥—Ä–æ–∫–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –í—Ä–µ–º—è: $(date '+%H:%M:%S')" \
          -d disable_notification="true"
