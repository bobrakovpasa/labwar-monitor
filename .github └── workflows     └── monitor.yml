name: LabWar Monitor

on:
  schedule:
    # –ö–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
    - cron: '*/5 * * * *'
  workflow_dispatch:  # –î–ª—è —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞

jobs:
  check-players:
    runs-on: ubuntu-latest
    
    steps:
    - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤
      id: check
      run: |
        # –°–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤ (–º–æ–∂–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å)
        PLAYERS=(
          "Barmaleikin" "Subbota96" "angel_of_dead1"
          "syslenok_88" "Lord555" "Znatok" "Sprei"
          "OBRON555" "den77" "CaIIIeHbkA" "_4ka_" "MeinKrieg"
          "_ASUS_" "AvtoRitet" "Zipp0_" "_DONZ_" "B_A_T"
          "xxxMAXxxx" "Klassik" "CHIPS" "Diabolo" "Ded1"
          "RED_HEAD_" "ShymaXER" "Krot13" "KAMAZ"
          "1Kazak1" "4uKaTuJIo" "PeaceDeath" "xXx_stalker_xXx" "jafar"
          "aleksandr_25" "Eclerhik" "Sharliz" "Wolf9" "PaHDoM"
        )
        
        # –ß–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫ –º–æ–±–æ–≤ (–ø—Ä–æ—Å—Ç—ã–µ –º–æ–±—ã)
        BAD_MOBS="–ú–æ—Ä—Ñ|–°–µ–∫—Ç–∞–Ω—Ç|–í–∞–º–ø–∏—Ä-–ø–ª–∞—Å—Ç—É–Ω|–°–µ—Ä–µ–±—Ä–∏—Å—Ç—ã–π –ú–æ—Ä—Ñ|–¢–æ–ø—Ç—É–Ω|–¢—Ä—É–ø–æ–µ–¥"
        BAD_MOBS="$BAD_MOBS|–ì–∏–≥–∞–Ω—Ç—Å–∫–∏–π –ú–æ—Ä—Ñ|–ë–æ–µ—Ü|–û—Ö—Ä–∞–Ω–Ω–∏–∫|–°—Ç–∞—Ä—ã–π —Ä–æ–±–æ—Ç"
        BAD_MOBS="$BAD_MOBS|–°–æ–±–∞–∫–∞-–º—É—Ç–∞–Ω—Ç|–®–Ω—ã—Ä—å|–ë–µ–ª–µ—Å–æ–µ —Å—É—â–µ—Å—Ç–≤–æ"
        
        echo "üöÄ –ù–∞—á–∏–Ω–∞—é –ø—Ä–æ–≤–µ—Ä–∫—É ${#PLAYERS[@]} –∏–≥—Ä–æ–∫–æ–≤..."
        
        for PLAYER in "${PLAYERS[@]}"
        do
          echo "üîç –ü—Ä–æ–≤–µ—Ä—è—é $PLAYER..."
          
          # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–≥—Ä–æ–∫–∞
          RESPONSE=$(curl -s "http://labwar.ru/log_infa.php?mod=who&blogin=$PLAYER")
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å "–í –±–æ—é"
          if [[ $RESPONSE == *"–í –±–æ—é"* ]] && [[ $RESPONSE == *"–°–º. –±–æ–π"* ]]; then
            echo "‚öîÔ∏è $PLAYER –≤ –±–æ—é!"
            
            # –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –ª–æ–≥ –±–æ—è
            BATTLE_LOG=$(echo "$RESPONSE" | grep -o "–ù–∞ .*–Ω–∞–ø–∞–¥–∞–µ—Ç.*\. –ë–æ–π –Ω–∞—á–∞–ª—Å—è" | head -1)
            
            if [ -n "$BATTLE_LOG" ]; then
              # –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–º—è –º–æ–±–∞
              MOB_NAME=$(echo "$BATTLE_LOG" | sed -n 's/.*–Ω–∞–ø–∞–¥–∞–µ—Ç \(.*\)\. –ë–æ–π –Ω–∞—á–∞–ª—Å—è/\1/p' | cut -d '[' -f1 | xargs)
              
              echo "üëπ –ú–æ–±: $MOB_NAME"
              
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫ (—Ä–µ–≥–∏—Å—Ç—Ä–æ–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ)
              MOB_LOWER=$(echo "$MOB_NAME" | tr '[:upper:]' '[:lower:]')
              
              if [[ ! $MOB_LOWER =~ $(echo "$BAD_MOBS" | tr '[:upper:]' '[:lower:]') ]]; then
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Telegram
                MESSAGE="‚öîÔ∏è –ë–û–ô: $PLAYER
                üïí $(date '+%H:%M:%S')
                üìù $BATTLE_LOG"
                
                curl -s -X POST "https://api.telegram.org/bot${{ secrets.BOT_TOKEN }}/sendMessage" \
                  -d chat_id="${{ secrets.CHAT_ID }}" \
                  -d text="$MESSAGE"
                
                echo "‚úÖ –û—Ç–ø—Ä–∞–≤–∏–ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø—Ä–æ $PLAYER vs $MOB_NAME"
              else
                echo "üö´ –ü—Ä–æ–ø—É—Å–∫–∞–µ–º: $MOB_NAME –≤ —á–µ—Ä–Ω–æ–º —Å–ø–∏—Å–∫–µ"
              fi
            fi
          fi
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ê–ë–ö (—Ä–∞–∑ –≤ 2 —á–∞—Å–∞)
          CURRENT_HOUR=$(date +%H)
          if [[ $RESPONSE == *"–ê—Ä–º–µ–π—Å–∫–∏–π –±–æ–µ–≤–æ–π –∫–æ–∫—Ç–µ–π–ª—å"* ]] && [[ $CURRENT_HOUR == "02" || $CURRENT_HOUR == "08" || $CURRENT_HOUR == "14" || $CURRENT_HOUR == "20" ]]; then
            echo "üíä $PLAYER —Å –ê–ë–ö!"
            curl -s -X POST "https://api.telegram.org/bot${{ secrets.BOT_TOKEN }}/sendMessage" \
              -d chat_id="${{ secrets.CHAT_ID }}" \
              -d text="$PLAYER –ê–ë–ö"
          fi
          
          # –ñ–¥–µ–º 2 —Å–µ–∫—É–Ω–¥—ã –º–µ–∂–¥—É –∏–≥—Ä–æ–∫–∞–º–∏ (—á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞—Ç—å)
          sleep 2
        done
        
        echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
